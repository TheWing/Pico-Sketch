pico-8 cartridge // http://www.pico-8.com
version 26
__lua__
rates={}
reverb={}
distorsion={}
filter={}
ch1={}
ch2={}
ch3={}
ch4={}


scrstart=0x6000
scrend=0x7fff
t=0
b=0
c=0
p=0
bb=0
bds=0
rec=-1


function _init()
 --[
 -- palette gradient
 poke4(0x5f10,0x8582.8000)
 poke4(0x5f14,0x0706.8605)
 poke4(0x5f18,0x088e.0987)
 poke4(0x5f1c,0x8084.0288)
 poke(0x5f2e,1)
 --]]
	-- music init

	poke(0x5f40,0b1111)
	poke(0x5f41,0b0000)
	poke(0x5f42,0b0001)
	poke(0x5f43,0b0001)

	music(0)

end 

function _update60()
 b=15-btn()
 bb=stat(26)/3.
 if flr(bb%16)==8 or flr(bb%16)==9 then
  bds=2
 else
 	bds=0
 end
 t=t*0.9+bds*0.001
 if rec==1 then
  update_music_stats()
 end
end

function _draw()
--[
 rectfill(0,0,128,128,15)
 	for mem=scrstart,scrend do
 		c=((mem%64)^^(mem>>>7))*0.2+t*300--(1+sin(t)*8)
 		p=1
 		p1=((c&b))
 		p2=((c&b))
  	poke(mem,0x00-((p2-1<<4)|p1)) 
 	end
 if rec==1 then
 rectfill(0,0,31,128,0)
  draw_music_stats()
  print(bds,0,50,8)
 end
 rec=btn()>>>12&1
 --]]
 --[[
 rectfill(0,0,128,128,0)
 for i=0,15 do
  print(@(0x5f10+i),0,6*i,i)
  
  print(i,4*4,6*i,i)
 end
 --]]
end




function stats(i,k,x,y,text)
	print("",x,y,7)
	print(text)
	color(8)
	for li=i,k do
	 print(stat(li))
	end
end

function update_music_stats()

	ch1=get_note(0)
	ch2=get_note(1)
	ch3=get_note(2)
	ch4=get_note(3)
end

--useful for debugging music
--things but definitely not
--needed in the production
function draw_music_stats()
	stats(16,19,0,0,"ptrn")
	--stats(20,23,4*5,0,"note")
	stats(24,24,0,6*5,"current")
	--stats(25,25,4*8,6*5,"played")
--	stats(26,26,0,6*7,"ticks")
--[[	
	for i=1,4 do
		rates[i]=(@0x5f40&(0b0001<<(i-1))!=0)
		reverb[i]=(@0x5f41&(0b0001<<(i-1))!=0)
		distorsion[i]=(@0x5f42&(0b0001<<(i-1))!=0)
		filter[i]=(@0x5f43&(0b0001<<(i-1))!=0)
	end
	print("half speed",4*15,0,7)
	print("",4*15,6,8)
	foreach(rates,print)
	color(7)
	print("reverb")
	color(8)
	foreach(reverb,print)
	color(7)
 print("distorsion")
	color(8)
	foreach(distorsion,print)
	color(7)
	print("lowpass filter")
	color(8)
	foreach(filter,print)
--]]
	print("█",0,122-ch1[1]/2,ch1[3])
	rectfill(1,122-ch1[1]/2,5,128-ch1[1]/2,0)
	print(ch1[4],0+2,122-ch1[1]/2,(ch1[2]+8)*(ch1[3]&1))
	print("█",2*3+1,122-ch2[1]/2,ch2[3])
	rectfill(8,122-ch2[1]/2,12,128-ch2[1]/2,0)
	print(ch2[4],2*3+3,122-ch2[1]/2,(ch2[2]+8)*(ch2[3]&1))
	print("█",2*6+2,122-ch3[1]/2,ch3[3])
	rectfill(15,122-ch3[1]/2,19,128-ch3[1]/2,0)
	print(ch3[4],2*6+4,122-ch3[1]/2,(ch3[2]+8)*(ch3[3]&1))
	print("█",2*9+3,122-ch4[1]/2,ch4[3])
	rectfill(22,122-ch4[1]/2,26,128-ch4[1]/2,0)
	print(ch4[4],2*9+5,122-ch4[1]/2,(ch4[2]+8)*(ch4[3]&1))
end


-- returns a table of four 
-- pitch, instrument, vol, fx
function get_note(ch)
 local sf = stat(16+ch)
 local tm = stat(20+ch)
 local addr = %(0x3200 + 68*sf + 2*tm)
 --      bitmap    sfx
 --       for         vol
 --      notes           inr
 --                         pitch   
 local pitch = (0b0000000000111111&addr)
 local instr = (0b0000000111000000&addr)>>>6
 local vol   = (0b0000111000000000&addr)>>>9
 local fx    = (0b0111000000000000&addr)>>>12
 return { pitch, instr, vol, fx }
end
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000015d67a80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
010100000360000600006000160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
010300202435311010110201103011040110501105011050306200c6351101011010110201103011040110501105011050110501105024353117101172011730306200c635110101101011020110301104011050
01030020243530d0100d0200d0300d0400d0500d0500d050306200c6350d0100d0100d0200d0300d0400d0500d0500d0500d0500d050243530d7100d7200d730306200c6350d0100d0100d0200d0300d0400d050
01030020243530f0100f0200f0300f0400f0500f0500f050306200c6350f0100f0100f0200f0300f0400f0500f0500f0500f0500f050243530f7100f7200f730306200c6350f0100f0100f0200f0300f0400f050
01030020243530507511000110001100011000110001100030620110501105011050110501105011050110501105011050110501105024353117101172011730306200c635110101101011020110301104011050
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01030020243530d3100d3200d3300d3400d3500d3500d350306200c6350d3100d3100d3200d3300d3400d3500d3500d3500d3500d350243530d3100d3200d330306200c6350d3100d3100d3200d3300d3400d350
01030020243530f3100f3200f3300f3400f3500f3500f350306200c6350f3100f3100f3200f3300f3400f3500f3500f3500f3500f350243530f3100f3200f330306200c6350f3100f3100f3200f3300f3400f350
010300202435311310113201133011340113501135011350306200c6351131011310113201133011340113501135011350113501135024353113101132011330306200c635113101131011320113301134011350
010300202435319010190201903019040190501905019050306200c6351901019010190201903019040190501905019050190501905024353197101972019730306200c635190101901019020190301904019050
01030020243531b0101b0201b0301b0401b0501b0501b050306200c6351b0101b0101b0201b0301b0401b0501b0501b0501b0501b050243531b7100370030600306200c6351b0001b0001d050160511305111051
01030020243530507511000110001100011000110001100030620113501135011350113501135011350113501135011350113501135024353113101132011330306200c635113101131011320113301134011350
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
010300202435319310193201933019340193501935019350306200c6351931019310193201933019340193501935019350193501935024353193101932019330306200c635193101931019320193301934019350
01030020243531b3101b3201b3301b3401b3501b3501b350306200c6351b3101b3101b3201b3301b3401b3501b3501b3501b3501b350243531b7100370030600306200c6351b0001b0001d050160511305111051
01030020180530500005000050001c615050000500005000306200c63500000000001c615000001c615000001c615000001c6151800018053057000570005700306200c63500605000001c615000001c61500000
01030020180530500005000050001c615050000500005000306200c63500000000001805300000046001800004600000000460018000306200c6350570005700306000c6001c61518000306200c635306200c635
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0103002000700007000070000000000000000000000000003075030755007002470033750337553071030715357503575533710337152e7502e755357103571530750307552e7102e71533750337553071030715
01030020377503775533710337152e7502e755377103771530750307552e7102e71537750377553071030715387503875537710377152c7502c755387103871530750307552c7102c71533750337553071030715
010300202070000700337103371531750317550870000700337503375531710317153775037755337103371538750387553771037715317503175538710387153375033755317103171538750387553371033715
010300203a7503a75538710387152e7502e7553a7103a71531750317552e7102e71537750377553171031715387503875537710377152c7502c755387103871531750317552c7102c71533750337553171031715
__music__
01 0d1a0d22
00 0a1a0a23
00 0b1a0b24
00 0c1b0c25
00 0a1a0a22
00 0a1a0a23
00 131a1324
00 141b1425
01 151a0d22
00 121a0a23
00 101a0b24
00 111b0c25
00 121a0a22
00 121a0a23
00 181a1324
02 191b1425
01 22424344
00 23424344
00 24424344
02 25424344

